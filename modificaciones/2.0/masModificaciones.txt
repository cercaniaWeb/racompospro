1. Actualizaci√≥n del Motor Local (Dexie.js)

Primero, necesitamos que la base de datos del navegador soporte los nuevos m√≥dulos. No solo guardaremos ventas, ahora guardaremos traslados y consumos pendientes de sincronizar.

2. M√≥dulo de Traslados (Inventory Transfers)

Este componente permite crear una solicitud de traslado incluso sin internet. La guarda localmente y el Service Worker (o el hook de sync) la subir√° luego.
src/features/transfers/TransferManager.tsx
Nov 21, 1:28 AM

3. M√≥dulo de Consumo de Empleados

Este modal es cr√≠tico para control de mermas internas. Registra el costo, no la venta.
src/features/consumption/EmployeeConsumptionModal.tsx
Nov 21, 1:28 AM

4. M√≥dulo de Agenda / Pedidos (Smart Reordering)

Este componente analiza tu inventario local y te dice qu√© pedir.
src/features/orders/SmartReorderList.tsx
Nov 21, 1:28 AM

Resumen del Prototipo Entregado

    BD Local Potenciada (db.ts): Ahora Dexie soporta Traslados y Consumos, no solo ventas.

    Gestor de Traslados (TransferManager.tsx): Interfaz completa para seleccionar destino, agregar productos y encolar la solicitud.

    Consumo Interno (EmployeeConsumptionModal.tsx): Modal seguro con PIN para registrar mermas por alimentaci√≥n del personal.

    Agenda Inteligente (SmartReorderList.tsx): Dashboard autom√°tico que te dice qu√© comprar basado en reglas de stock m√≠nimo.

Con estos archivos + el Terminal.tsx y useScale.ts que generamos antes, tienes el 90% de la l√≥gica cr√≠tica del negocio corriendo en el cliente. El 10% restante es configurar Supabase y el sync en background.

¬øTe gustar√≠a que genere el script SQL para las tablas de transfers y employee_consumption en Supabase para que coincida con este frontend?

el consumo empleado es por que tienen derecho a consumir productos sin que se les combre pero, necesitamos descontarlo del inventario .... Platicame como es que ves el flujo de traslados??

¬°Claro que s√≠! Entiendo perfectamente la distinci√≥n. El "Consumo Empleado" es t√©cnicamente una merma autorizada o un gasto operativo, mientras que los traslados son la columna vertebral log√≠stica de una cadena de tiendas.

Aqu√≠ te explico mi visi√≥n t√©cnica y funcional para ambos, dise√±ados para tu arquitectura Local-First.

1. üçΩÔ∏è M√≥dulo: Consumo de Empleados (La "Venta" Interna)

El error com√∫n es tratar esto como una venta con precio $0. Eso "ensucia" tus reportes de ventas (baja el ticket promedio) y pierde el rastro del costo real.

El Enfoque Correcto: Es un movimiento de inventario negativo donde el "cliente" es el empleado y el valor de la transacci√≥n es el Costo de Adquisici√≥n (CPP), no el Precio de Venta.

Flujo Paso a Paso:

    Selecci√≥n: El empleado selecciona "Coca Cola" y "S√°ndwich" en la interfaz (usando el mismo buscador r√°pido que el POS).

    Autorizaci√≥n: Al dar clic en "Registrar Consumo", el sistema pide un PIN de Supervisor (o huella si tienes el hardware). Esto es vital para evitar auto-robos.

    Impacto Local (Dexie):

        Se crea un registro en la tabla consumptions local.

        Se descuenta el stock en db.products inmediatamente.

    Sincronizaci√≥n: Al subir a Supabase:

        Resta del inventario global.

        Genera un registro en la tabla de gastos_operativos (o similar) con el valor del costo del producto.

2. üì¶ M√≥dulo: Traslados de Inventario (El "Cerebro Log√≠stico")

Este es el flujo m√°s delicado. Si no se hace bien, el inventario se "duplica" o desaparece m√°gicamente. Mi visi√≥n se basa en una M√°quina de Estados estricta.

Getty Images

Los 4 Estados del Traslado:

    üü° Solicitado (requested)

        Qui√©n: Gerente de Tienda 1.

        Acci√≥n: "Necesito 20 Leches y 10 Quesos".

        Impacto en Inventario: NINGUNO. Es solo una lista de deseos.

        En Dexie: Se guarda localmente y se sube a Supabase para que Bodega lo vea.

    üîµ Aprobado / Preparaci√≥n (approved)

        Qui√©n: Jefe de Bodega.

        Acci√≥n: Revisa la solicitud. "Solo tengo 15 Leches, te mando esas".

        Impacto Cr√≠tico: Aqu√≠ ocurre el Bloqueo de Stock.

            En Bodega, el stock f√≠sico sigue siendo 15, pero el stock disponible para venta baja a 0.

            Esto evita que Bodega venda esas leches a otro cliente mientras las empacan.

    üöö En Tr√°nsito / Enviado (shipped)

        Qui√©n: Jefe de Bodega (al subir al cami√≥n).

        Acci√≥n: Confirma la salida f√≠sica.

        Impacto:

            Stock Bodega: -15 (Salida definitiva).

            Stock Tienda 1: No cambia a√∫n.

            Stock "En Tr√°nsito": +15 (Un limbo contable necesario).

    üü¢ Recibido (received)

        Qui√©n: Gerente Tienda 1 (al llegar el cami√≥n).

        Acci√≥n: Cuenta f√≠sicamente y confirma.

        Escenario Realista (Discrepancias): "Enviaste 15, pero llegaron 14 (una se rompi√≥)".

        Impacto:

            Stock "En Tr√°nsito": -15 (Se limpia).

            Stock Tienda 1: +14 (Entrada real).

            Merma/P√©rdida: 1 (Registrada autom√°ticamente a cargo de log√≠stica).

3. Implementaci√≥n T√©cnica (SQL Schema)

Para que esto funcione, necesitas estas tablas en Supabase. Copia y pega esto en tu editor SQL de Supabase para preparar el terreno.

migrations/01_transfers_and_consumption.sql
Nov 21, 1:36 AM

¬øC√≥mo se ve esto en la App (React)?

Para el Consumo de Empleados, ya te di el componente EmployeeConsumptionModal.tsx.

Para los Traslados, aqu√≠ te dejo el componente visual para Recibir la mercanc√≠a. Este es el punto cr√≠tico donde el gerente cuenta y reporta fallos.
src/features/transfers/TransferReceiveModal.tsx
Nov 21, 1:36 AM

Resumen

    Consumo Empleado: Es un gasto operativo, no una venta $0. Requiere PIN.

    Traslados: Usa estados (requested, shipped, received) para manejar el tiempo de tr√°nsito y las discrepancias.

    Seguridad: Las tablas SQL que te gener√© est√°n listas para soportar esta l√≥gica y mantener la integridad de los datos.

¬øTe hace sentido este flujo para tu operaci√≥n?

JUSTO!!! asi mismo es como esta planeado

¬°Claro que s√≠! Entiendo perfectamente la distinci√≥n. El "Consumo Empleado" es t√©cnicamente una merma autorizada o un gasto operativo, mientras que los traslados son la columna vertebral log√≠stica de una cadena de tiendas.

Aqu√≠ te explico mi visi√≥n t√©cnica y funcional para ambos, dise√±ados para tu arquitectura Local-First.

1. üçΩÔ∏è M√≥dulo: Consumo de Empleados (La "Venta" Interna)

El error com√∫n es tratar esto como una venta con precio $0. Eso "ensucia" tus reportes de ventas (baja el ticket promedio) y pierde el rastro del costo real.

El Enfoque Correcto: Es un movimiento de inventario negativo donde el "cliente" es el empleado y el valor de la transacci√≥n es el Costo de Adquisici√≥n (CPP), no el Precio de Venta.

Flujo Paso a Paso:

    Selecci√≥n: El empleado selecciona "Coca Cola" y "S√°ndwich" en la interfaz (usando el mismo buscador r√°pido que el POS).

    Autorizaci√≥n: Al dar clic en "Registrar Consumo", el sistema pide un PIN de Supervisor (o huella si tienes el hardware). Esto es vital para evitar auto-robos.

    Impacto Local (Dexie):

        Se crea un registro en la tabla consumptions local.

        Se descuenta el stock en db.products inmediatamente.

    Sincronizaci√≥n: Al subir a Supabase:

        Resta del inventario global.

        Genera un registro en la tabla de gastos_operativos (o similar) con el valor del costo del producto.

2. üì¶ M√≥dulo: Traslados de Inventario (El "Cerebro Log√≠stico")

Este es el flujo m√°s delicado. Si no se hace bien, el inventario se "duplica" o desaparece m√°gicamente. Mi visi√≥n se basa en una M√°quina de Estados estricta.

Los 4 Estados del Traslado:

    üü° Solicitado (requested)

        Qui√©n: Gerente de Tienda 1.

        Acci√≥n: "Necesito 20 Leches y 10 Quesos".

        Impacto en Inventario: NINGUNO. Es solo una lista de deseos.

        En Dexie: Se guarda localmente y se sube a Supabase para que Bodega lo vea.

    üîµ Aprobado / Preparaci√≥n (approved)

        Qui√©n: Jefe de Bodega.

        Acci√≥n: Revisa la solicitud. "Solo tengo 15 Leches, te mando esas".

        Impacto Cr√≠tico: Aqu√≠ ocurre el Bloqueo de Stock.

            En Bodega, el stock f√≠sico sigue siendo 15, pero el stock disponible para venta baja a 0.

            Esto evita que Bodega venda esas leches a otro cliente mientras las empacan.

    üöö En Tr√°nsito / Enviado (shipped)

        Qui√©n: Jefe de Bodega (al subir al cami√≥n).

        Acci√≥n: Confirma la salida f√≠sica.

        Impacto:

            Stock Bodega: -15 (Salida definitiva).

            Stock Tienda 1: No cambia a√∫n.

            Stock "En Tr√°nsito": +15 (Un limbo contable necesario).

    üü¢ Recibido (received)

        Qui√©n: Gerente Tienda 1 (al llegar el cami√≥n).

        Acci√≥n: Cuenta f√≠sicamente y confirma.

        Escenario Realista (Discrepancias): "Enviaste 15, pero llegaron 14 (una se rompi√≥)".

        Impacto:

            Stock "En Tr√°nsito": -15 (Se limpia).

            Stock Tienda 1: +14 (Entrada real).

            Merma/P√©rdida: 1 (Registrada autom√°ticamente a cargo de log√≠stica).

3. Implementaci√≥n T√©cnica (SQL Schema)

Para que esto funcione, necesitas estas tablas en Supabase. Copia y pega esto en tu editor SQL de Supabase para preparar el terreno.
